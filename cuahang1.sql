CONNECT CH1/CH1;
DROP TABLE CH1.SUATUOI;

CREATE TABLE CH1.SUATUOI
(
MaLS VARCHAR2(10) PRIMARY KEY, 
TenLS VARCHAR2(100),
HuongVi VARCHAR2(50), 
TheTich VARCHAR2(20), 
ThuongHieu VARCHAR2(50),
HSD DATE,
Gia NUMBER 
);

CREATE TABLE CH1.CUAHANG
(
MaCH VARCHAR2(10) PRIMARY KEY, 
TenCH VARCHAR2(50),
DiaChi VARCHAR2(100), 
SDT VARCHAR2(10)
);

CREATE TABLE CH1.NHANVIEN
(
MaNV VARCHAR2(10) PRIMARY KEY, 
MaCH VARCHAR2(10),
TenNV VARCHAR2(50), 
SDT VARCHAR2(10),
GioiTinh VARCHAR2(5),
Luong NUMBER
);

CREATE TABLE CH1.KHACHHANG
(
MaKH VARCHAR2(10) PRIMARY KEY, 
TenKH VARCHAR2(50),
SDT VARCHAR2(10),
DiaChi VARCHAR2(100)
);

CREATE TABLE CH1.KHOHANG_QLKHO
(
MaCH VARCHAR2(10), 
MaLS VARCHAR2(10),
SoLuong NUMBER, 
NgayNhap DATE
);

CREATE TABLE CH1.KHOHANG_NV
(
MaCH VARCHAR2(10), 
MaLS VARCHAR2(10),
TinhTrang VARCHAR2(20)
);

CREATE TABLE CH1.HOADON
(
MaHD VARCHAR2(10) PRIMARY KEY, 
MaNV VARCHAR2(10),
MaKH VARCHAR2(10), 
MaCH VARCHAR2(10), 
TongTien NUMBER,
NgayHD DATE
);
CREATE TABLE CH1.CTHD
(
MaHD VARCHAR2(10), 
MaLS VARCHAR2(10),
SoLuong NUMBER
);

ALTER USER CH1 QUOTA UNLIMITED ON USERS;

--Them du lieu vao bang SUATUOI:
INSERT INTO CH1.SUATUOI 
VALUES ('LS001', 'S?a t??i ti?t tr�ng Vinamilk', 'Ng?t', '150ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 10000);
INSERT INTO CH1.SUATUOI 
VALUES ('LS002', 'S?a t??i ti?t tr�ng Vinamilk', '�t Ng?t', '150ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 10000);
INSERT INTO CH1.SUATUOI 
VALUES ('LS003', 'S?a t??i ti?t tr�ng Vinamilk', 'Kh�ng ???ng', '150ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 10000);
INSERT INTO CH1.SUATUOI 
VALUES ('LS004', 'S?a t??i ti?t tr�ng Vinamilk', 'D�u', '150ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 12500);
INSERT INTO CH1.SUATUOI 
VALUES ('LS005', 'S?a t??i ti?t tr�ng Vinamilk', 'Chocolate', '400ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 25000);
INSERT INTO CH1.SUATUOI 
VALUES ('LS006', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', 'Ng?t', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
INSERT INTO CH1.SUATUOI 
VALUES ('LS007', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', '�t Ng?t', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
INSERT INTO CH1.SUATUOI 
VALUES ('LS008', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', 'Kh�ng ???ng', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
INSERT INTO CH1.SUATUOI 
VALUES ('LS009', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', 'D�u', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
INSERT INTO CH1.SUATUOI 
VALUES ('LS010', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', 'Chocolate', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
--Them du lieu vao bang CUAHANG
INSERT INTO CH1.CUAHANG
VALUES ('CH001', 'C?a h�ng S?a T??i 1', 'Q1 Tp.HCM', '1234567890');
INSERT INTO CH1.CUAHANG 
VALUES ('CH002', 'C?a h�ng S?a T??i 2', 'Q7 Tp.HCM', '0987654321');
--Them du lieu vao bang NHANVIEN
INSERT INTO CH1.NHANVIEN
VALUES ('NV001', 'CH001', 'Nguy?n Kh�nh V?n', '0123456789', 'Nam', 5000000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV002', 'CH001', 'L� Th? Ki?u Lam', '0987654321', 'N?', 4500000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV003', 'CH001', '??ng Quang Nh?t', '0987645123', 'Nam', 3500000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV004', 'CH001', 'Ho�ng Qu?c Vi?t', '0987654123', 'Nam', 4000000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV005', 'CH001', 'L� Th? L? Tr�c', '0897654321', 'N?', 4500000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV006', 'CH001', 'Tr?n Qu?c Khang', '0867954321', 'N?', 3000000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV007', 'CH001', 'Ng� V?n M?nh', '0869574321', 'Nam', 5000000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV008', 'CH001', 'Tr?n Ho�ng Nh?t', '0864759321', 'Nam', 4500000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV009', 'CH001', 'Tr?n Phan Thanh Th?o', '0823415679', 'N?', 4000000);
INSERT INTO CH1.NHANVIEN
VALUES ('NV010', 'CH001', '?�o Minh Tu?', '0867123549', 'N?', 3500000);
--Them du lieu vao bang KHACHHANG
INSERT INTO CH1.KHACHHANG
VALUES ('KH001', 'Nguy?n V?n A', '1234567890', 'Qu?n 9');
INSERT INTO CH1.KHACHHANG
VALUES ('KH002', 'Tr?n Th? B', '0987456321', 'Qu?n 1');
INSERT INTO CH1.KHACHHANG
VALUES ('KH003', 'Nguy?n V?n C', '0789654321', 'Qu?n 10');
INSERT INTO CH1.KHACHHANG
VALUES ('KH004', 'Tr?n Th? D', '0143256789', 'Qu?n 5');
INSERT INTO CH1.KHACHHANG 
VALUES ('KH005', 'L� V?n E', '0987654123', 'Qu?n 7');
INSERT INTO CH1.KHACHHANG 
VALUES ('KH006', 'Ph?m Th? F', '0125436789', 'Qu?n 3');
INSERT INTO CH1.KHACHHANG 
VALUES ('KH007', 'V� V?n G', '0987634521', 'Qu?n 12');
INSERT INTO CH1.KHACHHANG 
VALUES ('KH008', 'Nguy?n Th? H', '0123475689', 'Qu?n B�nh Th?nh');
INSERT INTO CH1.KHACHHANG 
VALUES ('KH009', 'Tr?n V?n I', '0984675321', 'Qu?n T�n B�nh');
INSERT INTO CH1.KHACHHANG 
VALUES ('KH010', 'L� Th? K', '0123456978', 'Qu?n Ph� Nhu?n');

-- KHOHANG_QLKHO
INSERT INTO CH1. KHOHANG_QLKHO
VALUES ('CH001', 'LS001', 100, TO_DATE('01-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO
VALUES ('CH001', 'LS002', 50, TO_DATE('02-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO 
VALUES ('CH001', 'LS003', 200, TO_DATE('01-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO
VALUES ('CH001', 'LS004', 150, TO_DATE('03-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO 
VALUES ('CH001', 'LS005', 80, TO_DATE('03-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO 
VALUES ('CH001', 'LS006', 120, TO_DATE('05-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO 
VALUES ('CH001', 'LS007', 90, TO_DATE('02-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO 
VALUES ('CH001', 'LS008', 60, TO_DATE('02-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO 
VALUES ('CH001', 'LS009', 180, TO_DATE('02-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.KHOHANG_QLKHO 
VALUES ('CH001', 'LS010', 75, TO_DATE('05-12-2023', 'DD-MM-YYYY'));
--Them du lieu vao bang KHOHANG_NV
INSERT INTO CH1.KHOHANG_NV 
VALUES ('CH001', 'LS001', 'C�n h�ng');
INSERT INTO CH1.KHOHANG_NV
VALUES ('CH001', 'LS002', 'C�n h�ng');
INSERT INTO CH1.KHOHANG_NV 
VALUES ('CH001', 'LS003', 'H?t h�ng');
INSERT INTO CH1.KHOHANG_NV 
VALUES ('CH001', 'LS004', 'C�n h�ng');
INSERT INTO CH1.KHOHANG_NV 
VALUES ('CH001', 'LS005', 'H?t h�ng');
INSERT INTO CH1.KHOHANG_NV
VALUES ('CH001', 'LS006', 'C�n h�ng');
INSERT INTO CH1.KHOHANG_NV
VALUES ('CH001', 'LS007', 'H?t h�ng');
INSERT INTO CH1.KHOHANG_NV 
VALUES ('CH001', 'LS008', 'H?t h�ng');
INSERT INTO CH1.KHOHANG_NV 
VALUES ('CH001', 'LS009', 'C�n h�ng');
INSERT INTO CH1.KHOHANG_NV 
VALUES ('CH001', 'LS010', 'C�n h�ng');
--Them du lieu vao bang HOADON
INSERT INTO CH1.HOADON 
VALUES ('HD001', 'NV001', 'KH001', 'CH001', 100000, TO_DATE('01-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON
VALUES ('HD002', 'NV002', 'KH002', 'CH001', 150000, TO_DATE('03-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON
VALUES ('HD003', 'NV001', 'KH003', 'CH001', 80000, TO_DATE('03-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON 
VALUES ('HD004', 'NV003', 'KH004', 'CH001', 200000, TO_DATE('04-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON 
VALUES ('HD005', 'NV002', 'KH005', 'CH001', 40000, TO_DATE('04-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON 
VALUES ('HD006', 'NV004', 'KH006', 'CH001', 100000, TO_DATE('04-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON 
VALUES ('HD007', 'NV004', 'KH007', 'CH001', 180000, TO_DATE('07-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON 
VALUES ('HD008', 'NV003', 'KH008', 'CH001', 150000, TO_DATE('08-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON 
VALUES ('HD009', 'NV005', 'KH009', 'CH001', 160000, TO_DATE('08-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.HOADON 
VALUES ('HD010', 'NV001', 'KH010', 'CH001', 125000, TO_DATE('08-12-2023', 'DD-MM-YYYY'));
--Them du lieu cho bang CTHD
INSERT INTO CH1.CTHD 
VALUES ('HD001', 'LS003',10);
INSERT INTO CH1.CTHD 
VALUES ('HD002', 'LS009',10);
INSERT INTO CH1.CTHD 
VALUES ('HD003', 'LS002',8);
INSERT INTO CH1.CTHD 
VALUES ('HD004', 'LS001',20);
INSERT INTO CH1.CTHD 
VALUES ('HD005', 'LS001',4);
INSERT INTO CH1.CTHD 
VALUES ('HD006', 'LS005',4);
INSERT INTO CH1.CTHD 
VALUES ('HD007', 'LS008',12);
INSERT INTO CH1.CTHD 
VALUES ('HD008', 'LS004',12);
INSERT INTO CH1.CTHD 
VALUES ('HD009', 'LS003',16);
INSERT INTO CH1.CTHD
VALUES ('HD010', 'LS004',10);

-- GiamDoc
CREATE USER GiamDoc1 IDENTIFIED BY GiamDoc1;
GRANT CONNECT, CREATE PUBLIC DATABASE LINK TO GiamDoc1;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH1.SUATUOI TO GiamDoc1;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH1.CUAHANG TO GiamDoc1;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH1.NHANVIEN TO GiamDoc1;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH1.KHACHHANG TO GiamDoc1;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH1.KHOHANG_QLKHO TO GiamDoc1;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH1.KHOHANG_NV TO GiamDoc1;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH1.HOADON TO GiamDoc1;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH1.CTHD TO GiamDoc1;
GRANT CREATE ANY TRIGGER TO GIAMDOC1;
GRANT CREATE ANY PROCEDURE TO GIAMDOC1;
CREATE PUBLIC DATABASE LINK giamdoc1_dblink CONNECT TO GiamDoc2 IDENTIFIED BY GiamDoc2 USING 'CN2';
-- Quan ly
CREATE USER QuanLyCH1 IDENTIFIED BY QuanLyCH1;
GRANT CONNECT, CREATE PUBLIC DATABASE LINK TO QuanLyCH1;
GRANT SELECT, INSERT, UPDATE ON CH1.SUATUOI TO QuanLyCH1;
GRANT SELECT, INSERT, UPDATE ON CH1.NHANVIEN TO QuanLyCH1;
GRANT SELECT, INSERT, UPDATE ON CH1.KHACHHANG TO QuanLyCH1;
GRANT SELECT, INSERT, UPDATE ON CH1.KHOHANG_QLKHO TO QuanLyCH1;
GRANT SELECT, INSERT, UPDATE ON CH1.KHOHANG_NV TO QuanLyCH1;
GRANT SELECT, INSERT, UPDATE ON CH1.HOADON TO QuanLyCH1;
GRANT SELECT, INSERT, UPDATE ON CH1.CTHD TO QuanLyCH1;
CREATE PUBLIC DATABASE LINK quanlych1_dblink CONNECT TO QuanLyCH2 IDENTIFIED BY QuanLyCH2 USING 'CN2';
-- Nhan vien
CREATE USER NhanVienCH1 IDENTIFIED BY NhanVienCH1;
GRANT CONNECT, CREATE PUBLIC DATABASE LINK TO NhanVienCH1;
GRANT SELECT ON CH1.SUATUOI TO NhanVienCH1;
GRANT SELECT ON CH1.KHACHHANG TO NhanVienCH1;
GRANT SELECT ON CH1.KHOHANG_NV TO NhanVienCH1;
GRANT SELECT ON CH1.HOADON TO NhanVienCH1;
GRANT SELECT ON CH1.CTHD TO NhanVienCH1;
CREATE PUBLIC DATABASE LINK nvch1_dblink CONNECT TO NhanVienCH2 IDENTIFIED BY NhanVienCH2 USING 'CN2';

-- C�U 1
SELECT MaNV, TenNV, SDT
FROM CH1.NHANVIEN WHERE Luong >= 5000000
UNION
SELECT MaNV, TenNV, SDT
FROM CH2.NHANVIEN@giamdoc1_dblink
WHERE Luong >= 5000000 

-- CAU 2
SELECT ST1.MaLS, TenLS, HuongVi, Gia
FROM CH1.SUATUOI ST1 JOIN CH1.KHOHANG_NV NV1 ON ST1.MaLS = NV1.MaLS
WHERE TinhTrang = 'C�n h�ng'
INTERSECT
SELECT ST2.MaLS, TenLS, HuongVi, Gia
FROM CH2.SUATUOI@nvch1_dblink ST2 JOIN CH2.KHOHANG_NV@nvch1_dblink NV2 ON
ST2.MaLS = NV2.MaLS
WHERE TinhTrang = 'C�n h�ng'

-- Cau 3
SELECT HD1.MaCH, SUM(TongTien) AS DOANHTHU
FROM CH1.HOADON HD1
WHERE To_char (NgayHD, �mm�) = �12� GROUP BY HD1.MaCH
UNION 
SELECT HD2.MaCH, SUM(TongTien) DOANHTHU
FROM CH2.HOADON@giamdoc1_dblink HD2
WHERE To_char (NgayHD, �mm�) = �12� GROUP BY HD2.MaCH

-- Cau 4
SELECT ST.MaLS, TenLS, SUM(SoLuong)
FROM CH1.SUATUOI ST, CH1.CTHD CT
WHERE CT.MaLS = ST.MaLS
GROUP BY ST.MaLS, TenLS
HAVING SUM(SoLuong) >= ALL
(SELECT SUM(SoLuong) FROM CH1.CTHD GROUP BY MaLS)

-- Cau 5
SELECT DISTINCT K.MaKH, TenKH
FROM CH1.KHACHHANG K1, CH1.HOADON H1
WHERE K1.MaKH = H1.MaKH
MINUS
SELECT DISTINCT K.MaKH, TenKH
FROM CH2.KHACHHANG K2, CH2.HOADON@giamdoc1_dblink H2
WHERE K2.MaKH = H2.MaKH

-- Cau 6
SELECT MaKH
FROM CH1.HOADON HD
WHERE NOT EXISTS 
(SELECT * FROM CH1.SUATUOI ST
WHERE THUONGHIEU = 'TH True Milk' AND NOT EXISTS
(SELECT * FROM CH1.CTHD CT
WHERE CT.MaHD=HD.MaHD AND CT.MaLS =ST.MaLS))

-- Cau 7
SELECT K1.MaKH, TenKH
FROM CH1.KHACHHANG K1, CH1.HOADON H1
WHERE K1.MaKH = H1.MaKH
INTERSECT
SELECT K2.MaKH, TenKH
FROM CH2.KHACHHANG@giamdoc1_dblink K2, CH2.HOADON@giamdoc1_dblink H2
WHERE K2.MaKH = H2.MaKH

-- Cau 8
SELECT *
FROM (SELECT CT1.MALS, TENLS, ThuongHieu, MACH, SUM(SOLUONG)
FROM CH1.SUATUOI ST1, CH1.HOADON HD1, CH1.CTHD CT1
WHERE ST1.MaLS = CT1.MaLS AND CT1.MaHD = HD1.MaHD AND To_char (NgaHD,�mm�) = �12�
GROUP BY CT1.MaLS, TenLS, ThuongHieu, MaCH
ORDER BY SUM(SoLuong) DESC)
WHERE Rownum <= 3
UNION
SELECT *
FROM (SELECT CT2.MaLS, TenLS, ThuongHieu,MaCH,SUM(SoLuong)
FROM CH2.SUATUOI@quanly1_dblink ST2, CH2.HOADON@quanly1_dblink HD2, CH2.CTHD@quanly1_dblink CT1
WHERE ST2.MaLS=CT2.MaLS AND CT2.MaHD=HD2.MaHD AND To_char (NgayHD,�mm�) = �12�
GROUP BY CT2.MaLS, TenLS, ThuongHieu, MaCH
ORDER BY SUM(SoLuong) DESC)
WHERE Rownum <= 3

-- CAU 9
SELECT MaLS, TenLS
FROM CH1.SUATUOI
WHERE MaLS NOT IN (SELECT MaLS FROM CH1.CTHD)
INTERSECT
SELECT MaLS, TenLS FROM CH2.SUATUOI@giamdoc1_dblink
WHERE MaLS NOT IN (SELECT MaLS FROM CH2.CTHD@giamdoc1_dblink)

-- Cau 10
SELECT ST1.MaLS, TenLS
FROM CH1.SUATUOI ST1, CH1.KHOHANG_NV KH1
WHERE ST1.MaLS = KH1.MaLS AND KH1.TinhTrang = �C�n h�ng�
UNION
SELECT ST2.MaLS, TenLS
FROM CH2.SUATUOI@giamdoc1_dblink ST2, CH2.KHOHANG_NV@giamdoc1_dblink KH2
WHERE ST2.MaLS = KH2.MaLS AND KH2.TinhTrang = �H?t h�ng�

--ISOLATION
ALTER SESSION SET ISOLATION_LEVEL = SERIALIZABLE;

INSERT INTO CH2.KHACHHANG@giamdoc1_dblink VALUES ('KH035','Kh�nh 123 V?ng','142356789','Qu?n Kh�nh V?ng');

UPDATE CH2.KHACHHANG@giamdoc1_dblink
SET DiaChi = 'Qu?n 11'              
WHERE MaKH='KH021';

commit;
SELECT * FROM CH2.KHACHHANG@giamdoc1_dblink

--Explain query
SELECT NV.MaNV, NV.MaCH, NV.TenNV, SUM(QLK.SoLuong) 
FROM NHANVIEN NV
JOIN KHOHANG_QLKHO QLK ON QLK.MaCH = NV.MaCH
JOIN KHOHANG_NV KHNV ON KHNV.MaCH = NV.MaCH
WHERE QLK.NgayNhap > '02-DEC-23' AND NV.GioiTinh = 'Nữ' AND KHNV.TinhTrang = ‘Hết hàng’
GROUP BY NV.MaNV,NV.MaCH,NV.TenNV

EXPLAIN PLAN FOR SELECT NV.MaNV, NV.MaCH, NV.TenNV, SUM(QLK.SoLuong) 
FROM NHANVIEN NV
JOIN KHOHANG_QLKHO QLK ON QLK.MaCH = NV.MaCH
JOIN KHOHANG_NV KHNV ON KHNV.MaCH = NV.MaCH
WHERE QLK.NgayNhap > '02-DEC-23' AND NV.GioiTinh = 'Nữ' AND KHNV.TinhTrang = ‘Hết hàng’
GROUP BY NV.MaNV,NV.MaCH,NV.TenNV

 -- trigger insert
 CREATE OR REPLACE TRIGGER TR_CHECK_GIA_INSERT
 BEFORE INSERT OR UPDATE ON CH2.SUATUOI FOR EACH ROW
 BEGIN
IF(:NEW.Gia<=0)
 THEN
 RAISE_APPLICATION_ERROR(-20100, 'Gia s?a khong hop le, xin vui long nhap lai');
 END IF;
 END;

INSERT INTO CH1.SUATUOI@giamdoc2_dblink 
VALUES ('LS024', 'S?a t??i soloca thanh tr�ng TH True', 'Chocolate', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
select* from CH2.SUATUOI;
commit;
INSERT INTO CH1.SUATUOI@giamdoc2_dblink 
VALUES ('LS025', 'S?a t??i d�u thanh tr�ng TH True', 'd�u', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 0);

--FUNCTION
CREATE OR REPLACE FUNCTION sumPrice (customerId KHACHHANG.MaKH%TYPE) RETURN NUMBER
AS
  totalPrice NUMBER;
BEGIN
  SELECT SUM(TOTAL) INTO totalPrice
  FROM (
    SELECT SUM(TongTien) AS TOTAL FROM HOADON WHERE MaKH = customerId
    UNION
    SELECT SUM(TongTien) AS TOTAL FROM CH1.HOADON@giamdoc2_dblink WHERE MaKH = customerId
  );
  
  RETURN totalPrice;
END;

-- Run Function
SET SERVEROUTPUT ON;
 DECLARE
 t NUMBER;
BEGIN
 t := sumPrice('KH009');
 DBMS_OUTPUT.PUT_LINE('Tong tien: ' || t);
END;
 
INSERT INTO CH1.HOADON@giamdoc2_dblink
VALUES ('HD0056', 'NV006', 'KH024', 'CH002', 160000, TO_DATE('08-12-2023', 'DD-MM-YYYY'));
commit;
 
 select tongtien from CH1.HOADON@giamdoc2_dblink HD
 WHERE HD.MAKH ='KH009';
 
CREATE OR REPLACE FUNCTION sumPrice (customerId
 CUSTOMERS.CUSID%TYPE) RETURN NUMBER
 AS
 totalPrice NUMBER;
 BEGIN
 SELECT SUM(TOTAL) INTO totalPrice
 FROM (
 SELECT SUM(TongTien) AS TOTAL FROM
 HOADON WHERE MaKH=customerId
 UNION
 SELECT SUM (TongTien) AS TOTAL FROM
 HOADON@off2 WHERE MaKH=customerId);
 RETURN TongTien;
 END;

SET SERVEROUTPUT ON;
 DECLARE
 t NUMBER;
 
BEGIN
 t := sumPrice('KH009');
 DBMS_OUTPUT.PUT_LINE('Tong tien: ' || t);
 END;


--Procedure
CREATE OR REPLACE PROCEDURE PROCEDURE1(CUSID KHACHHANG.MAKH%TYPE) AS 
BEGIN
    FOR r IN (
        SELECT HD.MaCH, CTHD1.MaLS, ST.TenLS, SUM(CTHD1.SoLuong) AS TongSoLuong
        FROM CH1.CTHD CTHD1
        JOIN CH1.SUATUOI ST ON CTHD1.MaLS = ST.MaLS
        JOIN CH1.HOADON HD ON HD.MAHD = CTHD1.MAHD
        WHERE HD.MaKH = CUSID
        GROUP BY HD.MaCH, CTHD1.MaLS, ST.TenLS
        UNION ALL
        SELECT HD.MaCH, CTHD2.MaLS, ST.TenLS, SUM(CTHD2.SoLuong) AS TongSoLuong
        FROM CH2.CTHD@giamdoc1_dblink CTHD2
        JOIN CH2.SUATUOI@giamdoc1_dblink ST ON CTHD2.MaLS = ST.MaLS
        JOIN CH2.HOADON@giamdoc1_dblink HD ON HD.MAHD = CTHD2.MAHD
        WHERE HD.MaKH = CUSID
        GROUP BY HD.MaCH, CTHD2.MaLS, ST.TenLS
    )
    LOOP 
        DBMS_OUTPUT.PUT_LINE('Cua hang ' || r.MaCH || ': San pham ' || r.MaLS || ' (' || r.TenLS || ') - Tong so luong: ' || r.TongSoLuong);
    END LOOP;
END;

SET SERVEROUTPUT ON 
BEGIN 
PROCEDURE1('KH090'); 
END;
SELECT * FROM CH1.CTHD;
SELECT * FROM CH1.HOADON;
SELECT * FROM CH2.CTHD@giamdoc1_dblink;
commit;

-- Update trigger
CREATE OR REPLACE TRIGGER TR_CHECK_GIA_INSERT
 BEFORE INSERT OR UPDATE ON SUATUOI FOR EACH ROW
 BEGIN
IF(:NEW.Gia<=0)
 THEN
 RAISE_APPLICATION_ERROR(-20100, 'Gia sua khong hop le, xin vui long nhap lai');
 END IF;
 END;

SELECT * FROM CH2.SUATUOI@giamdoc1_dblink;
UPDATE CH2.SUATUOI@giamdoc1_dblink SET Gia = 27000 WHERE MALS = 'LS035';

UPDATE CH2.SUATUOI@giamdoc1_dblink SET Gia = -27000 WHERE MALS = 'LS035';

INSERT INTO CH1.HOADON 
VALUES ('HD027', 'NV001', 'KH010', 'CH001', 125000, TO_DATE('08-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH1.CTHD
VALUES ('HD028', 'LS003',10);
INSERT INTO CH1.HOADON 
VALUES ('HD028', 'NV001', 'KH010', 'CH001', 10, TO_DATE('08-12-2023', 'DD-MM-YYYY'));
SELECT * FROM HOADON

















