CONNECT CH2/CH2;
DROP TABLE CH2.SUATUOI;

CREATE TABLE CH2.SUATUOI
(
MaLS VARCHAR2(10) PRIMARY KEY, 
TenLS VARCHAR2(100),
HuongVi VARCHAR2(50), 
TheTich VARCHAR2(20), 
ThuongHieu VARCHAR2(50),
HSD DATE,
Gia NUMBER 
);

CREATE TABLE CH2.CUAHANG
(
MaCH VARCHAR2(10) PRIMARY KEY, 
TenCH VARCHAR2(50),
DiaChi VARCHAR2(100), 
SDT VARCHAR2(10)
);

CREATE TABLE CH2.NHANVIEN
(
MaNV VARCHAR2(10) PRIMARY KEY, 
MaCH VARCHAR2(10),
TenNV VARCHAR2(50), 
SDT VARCHAR2(10),
GioiTinh VARCHAR2(5),
Luong NUMBER
);

CREATE TABLE CH2.KHACHHANG
(
MaKH VARCHAR2(10) PRIMARY KEY, 
TenKH VARCHAR2(50),
SDT VARCHAR2(10),
DiaChi VARCHAR2(100)
);

CREATE TABLE CH2.KHOHANG_QLKHO
(
MaCH VARCHAR2(10), 
MaLS VARCHAR2(10),
SoLuong NUMBER, 
NgayNhap DATE
);

CREATE TABLE CH2.KHOHANG_NV
(
MaCH VARCHAR2(10), 
MaLS VARCHAR2(10),
TinhTrang VARCHAR2(20)
);

CREATE TABLE CH2.HOADON
(
MaHD VARCHAR2(10) PRIMARY KEY, 
MaNV VARCHAR2(10),
MaKH VARCHAR2(10), 
MaCH VARCHAR2(10), 
TongTien NUMBER,
NgayHD DATE
);
drop table CN2.HOADON;

SELECT * FROM CN2.HOADON;

CREATE TABLE CH2.CTHD
(
MaHD VARCHAR2(10), 
MaLS VARCHAR2(10),
SoLuong NUMBER
);

ALTER USER CH2 QUOTA UNLIMITED ON USERS;


--Them du lieu vao bang SUATUOI:
INSERT INTO CH2.SUATUOI
VALUES ('LS021', 'S?a t??i ti?t tr�ng Vinamilk', 'Ng?t', '150ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 10000);
INSERT INTO CH2.SUATUOI
VALUES ('LS022', 'S?a t??i ti?t tr�ng Vinamilk', '�t Ng?t', '150ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 10000);
INSERT INTO CH2.SUATUOI
VALUES ('LS023', 'S?a t??i ti?t tr�ng Vinamilk', 'Kh�ng ???ng', '150ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 10000);
INSERT INTO CH2.SUATUOI 
VALUES ('LS024', 'S?a t??i ti?t tr�ng Vinamilk', 'D�u', '150ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 12500);
INSERT INTO CH2.SUATUOI 
VALUES ('LS025', 'S?a t??i ti?t tr�ng Vinamilk', 'Chocolate', '400ml', 'Vinamilk', TO_DATE('30-12-2024', 'DD-MM-YYYY'), 25000);
INSERT INTO CH2.SUATUOI 
VALUES ('LS026', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', 'Ng?t', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
INSERT INTO CH2.SUATUOI 
VALUES ('LS027', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', '�t Ng?t', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
INSERT INTO CH2.SUATUOI 
VALUES ('LS028', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', 'Kh�ng ???ng', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
INSERT INTO CH2.SUATUOI 
VALUES ('LS029', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', 'D�u', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
INSERT INTO CH2.SUATUOI 
VALUES ('LS030', 'S?a t??i nguy�n ch?t thanh tr�ng TH True Milk', 'Chocolate', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);

SELECT * FROM CH2.SUATUOI;

--Them du lieu vao bang CUAHANG
INSERT INTO CH2.CUAHANG 
VALUES ('CH002', 'C?a h�ng S?a T??i 2', 'Q7 Tp.HCM', '0987654321');

--Them du lieu vao bang NHANVIEN
INSERT INTO CH2.NHANVIEN
VALUES ('NV021', 'CH002', 'Nguy?n Ng?c Lam', '0123456789', 'Nam', 5000000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV022', 'CH002', 'Hu?nh H?ng Y?n', '0987654321', 'N?', 4500000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV023', 'CH002', 'Kh?ng ??ng Khoa', '0987645123', 'Nam', 3500000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV024', 'CH002', 'Nguy?n Thanh Tr�c', '0987654123', 'Nam', 4000000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV025', 'CH002', 'Nguy?n Th�i Ch� Ngh?a', '0897654321', 'N?', 4500000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV026', 'CH002', 'Tr?nh Nh�n Hi?u', '0867954321', 'N?', 3000000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV027', 'CH002', '?o�n Kh?c Huy', '0869574321', 'Nam', 5000000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV028', 'CH002', 'L� Ng?c H�n', '0864759321', 'Nam', 4500000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV029', 'CH002', 'Nguy?n Anh Th?', '0823415679', 'N?', 4000000);
INSERT INTO CH2.NHANVIEN
VALUES ('NV030', 'CH002', 'Tr?n T�ng Linh', '0867123549', 'N?', 3500000);

--Them du lieu vao bang KHACHHANG
INSERT INTO CH2.KHACHHANG
VALUES ('KH021', 'Nguy?n V?n J', '1234567890', 'Qu?n 9');
INSERT INTO CH2.KHACHHANG
VALUES ('KH022', 'Tr?n Th? L', '0987456321', 'Qu?n 1');
INSERT INTO CH2.KHACHHANG
VALUES ('KH023', 'Nguy?n V?n M', '0789654321', 'Qu?n 10');
INSERT INTO CH2.KHACHHANG
VALUES ('KH024', 'Tr?n Th? N', '0143256789', 'Qu?n 5');
INSERT INTO CH2.KHACHHANG 
VALUES ('KH025', 'L� V?n O', '0987654123', 'Qu?n 7');
INSERT INTO CH2.KHACHHANG 
VALUES ('KH026', 'Ph?m Th? P', '0125436789', 'Qu?n 3');
INSERT INTO CH2.KHACHHANG 
VALUES ('KH027', 'V� V?n Q', '0987634521', 'Qu?n 12');
INSERT INTO CH2.KHACHHANG 
VALUES ('KH028', 'Nguy?n Th? R', '0123475689', 'Qu?n B�nh Th?nh');
INSERT INTO CH2.KHACHHANG 
VALUES ('KH029', 'Tr?n V?n S', '0984675321', 'Qu?n T�n B�nh');
INSERT INTO CH2.KHACHHANG 
VALUES ('KH030', 'L� Th? T', '0123456978', 'Qu?n Ph� Nhu?n');

-- KHOHANG_QLKHO
INSERT INTO CH2. KHOHANG_QLKHO
VALUES ('CH002', 'LS021', 90, TO_DATE('07-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO
VALUES ('CH002', 'LS022', 100, TO_DATE('07-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO 
VALUES ('CH002', 'LS023', 300, TO_DATE('09-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO
VALUES ('CH002', 'LS024', 230, TO_DATE('09-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO 
VALUES ('CH002', 'LS025', 140, TO_DATE('12-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO 
VALUES ('CH002', 'LS026', 260, TO_DATE('12-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO 
VALUES ('CH002', 'LS027', 75, TO_DATE('13-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO 
VALUES ('CH002', 'LS028', 190, TO_DATE('14-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO 
VALUES ('CH002', 'LS029', 240, TO_DATE('15-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.KHOHANG_QLKHO 
VALUES ('CH002', 'LS030', 130, TO_DATE('15-12-2023', 'DD-MM-YYYY'));

--Them du lieu vao bang KHOHANG_NV
INSERT INTO CH2.KHOHANG_NV 
VALUES ('CH002', 'LS021', 'H?t h�ng');
INSERT INTO CH2.KHOHANG_NV
VALUES ('CH002', 'LS022', 'C�n h�ng');
INSERT INTO CH2.KHOHANG_NV 
VALUES ('CH002', 'LS023', 'C�n h�ng');
INSERT INTO CH2.KHOHANG_NV 
VALUES ('CH002', 'LS024', 'C�n h�ng');
INSERT INTO CH2.KHOHANG_NV 
VALUES ('CH002', 'LS025', 'C�n h�ng');
INSERT INTO CH2.KHOHANG_NV
VALUES ('CH002', 'LS026', 'C�n h�ng');
INSERT INTO CH2.KHOHANG_NV
VALUES ('CH002', 'LS027', 'H?t h�ng');
INSERT INTO CH2.KHOHANG_NV 
VALUES ('CH002', 'LS028', 'C�n h�ng');
INSERT INTO CH2.KHOHANG_NV 
VALUES ('CH002', 'LS029', 'C�n h�ng');
INSERT INTO CH2.KHOHANG_NV 
VALUES ('CH002', 'LS030', 'H?t h�ng');

--Them du lieu vao bang HOADON
INSERT INTO CH2.HOADON 
VALUES ('HD021', 'NV021', 'KH021', 'CH002', 900000, TO_DATE('07-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON
VALUES ('HD022', 'NV022', 'KH022', 'CH002', 300000, TO_DATE('07-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON
VALUES ('HD023', 'NV021', 'KH023', 'CH002', 50000, TO_DATE('010-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON 
VALUES ('HD024', 'NV023', 'KH024', 'CH002', 250000, TO_DATE('10-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON 
VALUES ('HD025', 'NV022', 'KH025', 'CH002', 120000, TO_DATE('10-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON 
VALUES ('HD026', 'NV024', 'KH026', 'CH002', 75000, TO_DATE('11-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON 
VALUES ('HD027', 'NV024', 'KH027', 'CH002', 300000, TO_DATE('11-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON 
VALUES ('HD028', 'NV023', 'KH028', 'CH002', 150000, TO_DATE('12-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON 
VALUES ('HD029', 'NV025', 'KH029', 'CH002', 90000, TO_DATE('13-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.HOADON 
VALUES ('HD030', 'NV021', 'KH030', 'CH002', 100000, TO_DATE('13-12-2023', 'DD-MM-YYYY'));

--Them du lieu cho bang CTHD
INSERT INTO CH2.CTHD 
VALUES ('HD021', 'LS029',60);
INSERT INTO CH2.CTHD 
VALUES ('HD022', 'LS024',24);
INSERT INTO CH2.CTHD 
VALUES ('HD023', 'LS025',2);
INSERT INTO CH2.CTHD 
VALUES ('HD024', 'LS025',10);
INSERT INTO CH2.CTHD 
VALUES ('HD025', 'LS021',12);
INSERT INTO CH2.CTHD 
VALUES ('HD026', 'LS027',5);
INSERT INTO CH2.CTHD 
VALUES ('HD027', 'LS028',20);
INSERT INTO CH2.CTHD 
VALUES ('HD028', 'LS030',10);
INSERT INTO CH2.CTHD 
VALUES ('HD029', 'LS023',9);
INSERT INTO CH2.CTHD
VALUES ('HD030', 'LS021',10);

-- GiamDoc
CREATE USER GiamDoc2 IDENTIFIED BY GiamDoc2;
GRANT CONNECT, CREATE PUBLIC DATABASE LINK TO GiamDoc2;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH2.SUATUOI TO GiamDoc2;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH2.CUAHANG TO GiamDoc2;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH2.NHANVIEN TO GiamDoc2;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH2.KHACHHANG TO GiamDoc2;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH2.KHOHANG_QLKHO TO GiamDoc2;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH2.KHOHANG_NV TO GiamDoc2;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH2.HOADON TO GiamDoc2;
GRANT SELECT, INSERT, UPDATE, DELETE ON CH2.CTHD TO GiamDoc2;
GRANT CREATE ANY TRIGGER TO GIAMDOC2;
GRANT CREATE ANY PROCEDURE TO GIAMDOC2;
CREATE PUBLIC DATABASE LINK giamdoc2_dblink CONNECT TO GiamDoc1 IDENTIFIED BY GiamDoc1 USING 'orcl';
-- Quan ly
CREATE USER QuanLyCH2 IDENTIFIED BY QuanLyCH2;
GRANT CONNECT, CREATE PUBLIC DATABASE LINK TO QuanLyCH2;
GRANT SELECT, INSERT, UPDATE ON CH2.SUATUOI TO QuanLyCH2;
GRANT SELECT, INSERT, UPDATE ON CH2.NHANVIEN TO QuanLyCH2;
GRANT SELECT, INSERT, UPDATE ON CH2.KHACHHANG TO QuanLyCH2;
GRANT SELECT, INSERT, UPDATE ON CH2.KHOHANG_QLKHO TO QuanLyCH2;
GRANT SELECT, INSERT, UPDATE ON CH2.KHOHANG_NV TO QuanLyCH2;
GRANT SELECT, INSERT, UPDATE ON CH2.HOADON TO QuanLyCH2;
GRANT SELECT, INSERT, UPDATE ON CH2.CTHD TO QuanLyCH2;
CREATE PUBLIC DATABASE LINK quanlych2_dblink CONNECT TO QuanLyCH1 IDENTIFIED BY QuanLyCH1 USING 'orcl';

-- Nhan vien
CREATE USER NhanVienCH2 IDENTIFIED BY NhanVienCH2;
GRANT CONNECT, CREATE PUBLIC DATABASE LINK TO NhanVienCH2;
GRANT SELECT ON CH2.SUATUOI TO NhanVienCH2;
GRANT SELECT ON CH2.KHACHHANG TO NhanVienCH2;
GRANT SELECT ON CH2.KHOHANG_NV TO NhanVienCH2;
GRANT SELECT ON CH2.HOADON TO NhanVienCH2;
GRANT SELECT ON CH2.CTHD TO NhanVienCH2;
CREATE PUBLIC DATABASE LINK nvch2_dblink CONNECT TO NhanVienCH1 IDENTIFIED BY NhanVienCH1 USING 'orcl';

-- C�U 1
Select MaNV, TenNV, SDT
From CH2.NHANVIEN where Luong >= 5000000
UNION
Select MaNV, TenNV, SDT
From CH1.NHANVIEN@giamdoc2_dblink
Where Luong >= 5000000;

-- CAU 2
SELECT ST2.MaLS, TenLS, HuongVi, Gia
FROM CH2.SUATUOI ST2 JOIN CH2.KHOHANG_NV NV2 ON ST2.MaLS = NV2.MaLS
WHERE TinhTrang = 'C�n h�ng'
INTERSECT
SELECT ST1.MaLS, TenLS, HuongVi, Gia
FROM CH1.SUATUOI@nvch2_dblink ST1 JOIN CH1.KHOHANG_NV@nvch2_dblink NV1 ON ST1.MaLS = NV1.MaLS
WHERE TinhTrang = 'C�n h�ng';

-- Cau 3
SELECT HD2.MaCH, SUM(TongTien) DOANHTHU
FROM CH2.HoaDon HD2, NHANVIEN NV2, CUAHANG CH2
WHERE To_char (NgayHD, 'mm') = '12' GROUP BY HD2.MaCH
UNION 
SELECT HD1.MaCH, SUM(TongTien) DOANHTHU
FROM CH1.HOADON@giamdoc2_dblink HD1
WHERE To_char (NgayHD, 'mm') = '12' GROUP BY HD1.MaCH

-- Cau 4
SELECT ST.MaLS, TenLS, SUM(SoLuong)
FROM CH2.SUATUOI ST, CH2.CTHD CT
WHERE CT.MaLS = ST.MaLS
GROUP BY ST.MaLS, TenLS
HAVING SUM(SoLuong) >= ALL
(SELECT SUM(SoLuong) FROM CH2.CTHD GROUP BY MaLS)

-- Cau 5
SELECT DISTINCT K.MaKH, TenKH
FROM KHACHHANG K, HOADON H1
WHERE K.MaKH = H1.MaKH
MINUS
SELECT DISTINCT K.MaKH, TenKH
FROM KHACHHANG K, CH1.HOADON@nvch2_dblink P2
WHERE K.MaKH = P2.MaKH

-- Cau 6
SELECT MaKH
FROM CH2.HOADON HD
WHERE NOT EXISTS 
(SELECT * FROM CH2.SUATUOI ST
WHERE THUONGHIEU = 'TH True Milk' AND NOT EXISTS
(SELECT * FROM CH2.CTHD CT
WHERE CT.MaHD=HD.MaHD AND CT.MaLS =ST.MaLS))

-- Cau 7
SELECT K2.MaKH, TenKH
FROM KHACHHANG K2, HOADON H2
WHERE K2.MaKH = H2.MaKH
INTERSECT
SELECT K1.MaKH, TenKH
FROM CH1.KHACHHANG@giamdoc2_dblink K1, CH1.HOADON@giamdoc2_dblink C1
WHERE K1.MaKH = C1.MaKH

-- Cau 8
SELECT *
FROM (SELECT CT2.MALS, TENLS, ThuongHieu, MACH, SUM(SOLUONG)
FROM CH2.SUATUOI ST2, CH2.HOADON HD2, CH2.CTHD CT2
WHERE ST2.MALS = CT2.MALS AND CT2.MAHD = HD2.MAHD AND To_char (NGAYHD,'mm') = '12'
GROUP BY CT2.MALS, TENLS, THUONGHIEU, MACH
ORDER BY SUM(SOLUONG) DESC)
WHERE Rownum <= 3
UNION
SELECT *
FROM (SELECT CT1.MALS,TENLS,ThuongHieu,MACH,SUM(SOLUONG)
FROM CH1.SUATUOI@giamdoc2_dblink ST1,CH1.HOADON@giamdoc2_dblink HD1, CH1.CTHD@giamdoc2_dblink CT1
WHERE ST1.MALS=CT1.MALS AND CT1.MAHD=HD1.MAHD AND To_char (NGAYHD,'mm') = '12'
GROUP BY CT1.MALS,TENLS,ThuongHieu,MACH
ORDER BY SUM(SOLUONG) DESC)
WHERE Rownum <=3

-- CAU 9
SELECT MALS, TENLS
FROM CH2.SUATUOI
WHERE MALS NOT IN (SELECT MALS FROM CH2.CTHD)
INTERSECT
SELECT MALS, TENLS FROM CH1.SUATUOI@giamdoc2_dblink
WHERE MALS NOT IN (SELECT MALS FROM CH1.CTHD@giamdoc2_dblink)

-- Cau 10
SELECT ST2.MALS, TENLS, KH2.TinhTrang
FROM CH2.SUATUOI ST2, CH2.KHOHANG_NV KH2
WHERE KH2.TinhTrang = 'H?t h�ng'
    AND ST2.MALS = KH2.MALS
UNION
SELECT ST1.MALS, TENLS , KH1.TinhTrang
FROM CH1.SUATUOI@giamdoc2_dblink ST1, CH1.KHOHANG_NV@giamdoc2_dblink KH1
WHERE KH1.TinhTrang = 'C�n h�ng'
    AND ST1.MALS = KH1.MALS

--ISOLATION
-- Lost updated 
UPDATE CH2.KHACHHANG
SET DIACHI = 'Quan Binh Thanh'            
WHERE MAKH= 'KH021';
commit;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT * FROM CH2.KHACHHANG;
SELECT DIACHI 
FROM CH2.KHACHHANG
WHERE MAKH ='KH021';

-- deadlock
UPDATE CH2.KHACHHANG
SET DIACHI = 'Qu?n 10'            
WHERE MAKH='KH021';

UPDATE CH2.KHACHHANG
SET DIACHI = 'Qu?n 8'           
WHERE MAKH='KH022';

commit;

select * from CH2.KHACHHANG;
--Phantom read 
INSERT INTO CH2.KHACHHANG VALUES ('KH032','Nguyen Quang Van','142356789','Qu?n B�nh Th?nh');
select * from CH2.KHACHHANG;
COMMIT;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
select * from CH2.KHACHHANG;

select * from CH1.SUATUOI@giamdoc2_dblink;

 -- trigger
 CREATE OR REPLACE TRIGGER TR_CHECK_GIA_INSERT
 BEFORE INSERT OR UPDATE ON CH2.SUATUOI FOR EACH ROW
 BEGIN
IF(:NEW.Gia<=0)
 THEN
 RAISE_APPLICATION_ERROR(-20100, 'Gia s?a khong hop le, xin vui long nhap lai');
 END IF;
 END;
 commit;

INSERT INTO CH1.SUATUOI@giamdoc2_dblink 
VALUES ('LS024', 'S?a t??i soloca thanh tr�ng TH True', 'Chocolate', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 15000);
select* from CH2.SUATUOI;
commit;
INSERT INTO CH1.SUATUOI@giamdoc2_dblink 
VALUES ('LS025', 'S?a t??i d�u thanh tr�ng TH True', 'd�u', '220ml', 'TH True Milk', TO_DATE('30-12-2025', 'DD-MM-YYYY'), 0);
select * from CH1.SUATUOI@giamdoc2_dblink;
Update CH1.SUATUOI@giamdoc2_dblink 
set GIA= 200000
where MaLS='LS004'
 
Update CH1.SUATUOI@giamdoc2_dblink 
set GIA= -50000
where MaLS='LS004'

--FUNCTION
CREATE OR REPLACE FUNCTION sumPrice (customerId KHACHHANG.MaKH%TYPE) RETURN NUMBER
AS
  totalPrice NUMBER;
BEGIN
  SELECT SUM(TOTAL) INTO totalPrice
  FROM (
    SELECT SUM(TongTien) AS TOTAL FROM HOADON WHERE MaKH = customerId
    UNION
    SELECT SUM(TongTien) AS TOTAL FROM CH1.HOADON@giamdoc2_dblink WHERE MaKH = customerId
  );
  
  RETURN totalPrice;
END;

-- Run Function
SET SERVEROUTPUT ON;
 DECLARE
 t NUMBER;
BEGIN
 t := sumPrice('KH009');
 DBMS_OUTPUT.PUT_LINE('Tong tien: ' || t);
END;
 
INSERT INTO CH1.HOADON@giamdoc2_dblink
VALUES ('HD0056', 'NV006', 'KH024', 'CH002', 160000, TO_DATE('08-12-2023', 'DD-MM-YYYY'));
commit;
 
 select tongtien from CH1.HOADON@giamdoc2_dblink HD
 WHERE HD.MAKH ='KH009';
 
 
INSERT INTO CH2.HOADON 
VALUES ('HD038', 'NV021', 'KH090', 'CH002', 125000, TO_DATE('08-12-2023', 'DD-MM-YYYY'));
INSERT INTO CH2.CTHD
VALUES ('HD038', 'LS003',10); 
commit;

-- Procedure
CREATE OR REPLACE PROCEDURE PROCEDURE1(CUSID KHACHHANG.MAKH%TYPE) AS 
BEGIN
    FOR r IN (
        SELECT HD.MaCH, CTHD1.MaLS, ST.TenLS, SUM(CTHD1.SoLuong) AS TongSoLuong
        FROM CH2.CTHD CTHD1
        JOIN CH2.SUATUOI ST ON CTHD1.MaLS = ST.MaLS
        JOIN CH2.HOADON HD ON HD.MAHD = CTHD1.MAHD
        WHERE HD.MaKH = CUSID
        GROUP BY HD.MaCH, CTHD1.MaLS, ST.TenLS
        UNION ALL
        SELECT HD.MaCH, CTHD2.MaLS, ST.TenLS, SUM(CTHD2.SoLuong) AS TongSoLuong
        FROM CH1.CTHD@giamdoc2_dblink CTHD2
        JOIN CH1.SUATUOI@giamdoc2_dblink ST ON CTHD2.MaLS = ST.MaLS
        JOIN CH1.HOADON@giamdoc2_dblink HD ON HD.MAHD = CTHD2.MAHD
        WHERE HD.MaKH = CUSID
        GROUP BY HD.MaCH, CTHD2.MaLS, ST.TenLS
    )
    LOOP 
        DBMS_OUTPUT.PUT_LINE('Cua hang ' || r.MaCH || ': San pham ' || r.MaLS || ' (' || r.TenLS || ') - Tong so luong: ' || r.TongSoLuong);
    END LOOP;
END;
 
 -- Procedure run
SET SERVEROUTPUT ON 
BEGIN 
PROCEDURE1('KH090'); 
END;

Update CH1.SUATUOI@giamdoc2_dblink 
set GIA= 200000
where MaLS='LS004'
 
Update CH1.SUATUOI@giamdoc2_dblink 
set GIA= -50000
where MaLS='LS004'

update CTHD
set SOLUONG=15
where MAHD='HD038'
commit;